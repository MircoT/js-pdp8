"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}!function(){function Token(type,val){_classCallCheck(this,Token),this.type=type,this.val=val}var types={NUMBER:Symbol("number"),HEX_NUM:Symbol("hex_number"),WORD:Symbol("word"),PUNCT:Symbol("punct"),BLANK:Symbol("blank"),NEWLINE:Symbol("newLine")},states={NONE:Symbol("none"),ERROR:Symbol("error"),END_CMD:Symbol("end_command"),COMMENT_INLINE:Symbol("comment_inline"),COMMENT_MULTILNE:Symbol("comment_multiline"),HEX_NUM:Symbol("hex_num"),HEX_VAL:Symbol("hex_val"),DEC_VAL:Symbol("dec_val"),ADDR_HEX_VAL:Symbol("addr_hex_val"),ADDR_DEC_VAL:Symbol("addr_dec_val"),ORG:Symbol("org"),LABEL:Symbol("label"),ADDRESS:Symbol("address"),INDIRECT:Symbol("indirect")},binOpt={AND:0,ADD:4096,LDA:8192,STA:12288,BUN:16384,BSA:20480,ISZ:24576,CLA:30720,CLE:29696,CMA:29184,CME:28928,CIR:28800,CIL:28736,INC:28704,SPA:28688,SNA:28680,SZA:28676,SZE:28674,HLT:28673,INP:63488,OUT:62464,ION:61568,IOF:61504},checkType=function(buff){return function(buff){"-"===buff[0]&&(buff=buff.slice(1));var number=!0,_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=buff[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var code=_step2.value.charCodeAt(0);number&=48<=code&&code<=57}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return!!number&&types.NUMBER}(buff)||function(buff){var number=!0,_iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=buff[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){var code=_step3.value.charCodeAt(0);number&=48<=code&&code<=57||65<=code&&code<=70||97<=code&&code<=102}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}return!!number&&types.HEX_NUM}(buff)||function(buff){var word=!0;if(48<=buff.charCodeAt(0)&&buff.charCodeAt(0)<=57)return!1;var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=buff[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var code=_step.value.charCodeAt(0);word&=65<=code&&code<=90||97<=code&&code<=122||95===code||48<=code&&code<=57}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return!!word&&types.WORD}(buff)||function(buff){var punct=!0,_iteratorNormalCompletion4=!0,_didIteratorError4=!1,_iteratorError4=void 0;try{for(var _step4,_iterator4=buff[Symbol.iterator]();!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=!0){var code=_step4.value.charCodeAt(0);punct&=33<=code&&code<=47||58<=code&&code<=63||91<=code&&code<=94||123<=code&&code<=126||96===code}}catch(err){_didIteratorError4=!0,_iteratorError4=err}finally{try{!_iteratorNormalCompletion4&&_iterator4.return&&_iterator4.return()}finally{if(_didIteratorError4)throw _iteratorError4}}return!!punct&&types.PUNCT}(buff)||function(buff){var blank=!0,_iteratorNormalCompletion5=!0,_didIteratorError5=!1,_iteratorError5=void 0;try{for(var _step5,_iterator5=buff[Symbol.iterator]();!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=!0){var c=_step5.value;blank&=" "===c||""===c||"\t"===c}}catch(err){_didIteratorError5=!0,_iteratorError5=err}finally{try{!_iteratorNormalCompletion5&&_iterator5.return&&_iterator5.return()}finally{if(_didIteratorError5)throw _iteratorError5}}return!!blank&&types.BLANK}(buff)||function(c){return"\n"===c&&types.NEWLINE}(buff)},to_base_2=function(num,num_bit){for(var str=(num&Math.pow(2,num_bit)-1).toString(2);str.length<num_bit;)str="0"+str;return str},exec_CLA=function(pdp8_obj){3===pdp8_obj.status.clock?(pdp8_obj.registers.AC=0,pdp8_obj.ctrlUnit.F=0,pdp8_obj.status.last_instr_exec="AC <- 0 , F <- 0"):pdp8_obj.status.last_instr_exec="NOP"},exec_CLE=function(pdp8_obj){3===pdp8_obj.status.clock?(pdp8_obj.registers.E=0,pdp8_obj.ctrlUnit.F=0,pdp8_obj.status.last_instr_exec="E <- 0 , F <- 0"):pdp8_obj.status.last_instr_exec="NOP"},exec_CMA=function(pdp8_obj){3===pdp8_obj.status.clock?(pdp8_obj.registers.AC=65535&~pdp8_obj.registers.AC,pdp8_obj.ctrlUnit.F=0,pdp8_obj.status.last_instr_exec="AC <- AC' , F <- 0"):pdp8_obj.status.last_instr_exec="NOP"},exec_CME=function(pdp8_obj){3===pdp8_obj.status.clock?(pdp8_obj.registers.E=1&~pdp8_obj.registers.E,pdp8_obj.ctrlUnit.F=0,pdp8_obj.status.last_instr_exec="E <- E' , F <- 0"):pdp8_obj.status.last_instr_exec="NOP"},exec_CIR=function(pdp8_obj){if(3===pdp8_obj.status.clock){var tmp=pdp8_obj.registers.E<<15;pdp8_obj.registers.E=1&pdp8_obj.registers.AC,pdp8_obj.registers.AC=pdp8_obj.registers.AC>>>1|tmp,pdp8_obj.registers.AC=65535&pdp8_obj.registers.AC,pdp8_obj.ctrlUnit.F=0,pdp8_obj.status.last_instr_exec="E-AC <- bit1 - E - (AC  bit1) , F <- 0"}else pdp8_obj.status.last_instr_exec="NOP"},exec_CIL=function(pdp8_obj){if(3===pdp8_obj.status.clock){var tmp=pdp8_obj.registers.AC;pdp8_obj.registers.AC=pdp8_obj.registers.AC<<1|pdp8_obj.registers.E,pdp8_obj.registers.AC=65535&pdp8_obj.registers.AC,pdp8_obj.registers.E=(32768&tmp)>>>15,pdp8_obj.ctrlUnit.F=0,pdp8_obj.status.last_instr_exec="E-AC <- AC-E , F <- 0"}else pdp8_obj.status.last_instr_exec="NOP"},exec_INC=function(pdp8_obj){if(3===pdp8_obj.status.clock){var tmp=(pdp8_obj.registers.E<<16)+pdp8_obj.registers.AC+1;pdp8_obj.registers.E=(65536&tmp)>>>16,pdp8_obj.registers.AC=65535&tmp,pdp8_obj.ctrlUnit.F=0,pdp8_obj.status.last_instr_exec="E-AC <- E-AC + 1 ,F <- 0"}else pdp8_obj.status.last_instr_exec="NOP"},exec_SPA=function(pdp8_obj){if(3===pdp8_obj.status.clock){0<(32767<pdp8_obj.registers.AC?pdp8_obj.registers.AC-Math.pow(2,16):pdp8_obj.registers.AC)&&pdp8_obj.registers.PC++,pdp8_obj.ctrlUnit.F=0,pdp8_obj.status.last_instr_exec="PC <- PC+1 if(AC>0) , F <- 0"}else pdp8_obj.status.last_instr_exec="NOP"},exec_SNA=function(pdp8_obj){if(3===pdp8_obj.status.clock){(32767<pdp8_obj.registers.AC?pdp8_obj.registers.AC-Math.pow(2,16):pdp8_obj.registers.AC)<0&&pdp8_obj.registers.PC++,pdp8_obj.ctrlUnit.F=0,pdp8_obj.status.last_instr_exec="PC <- PC+1 if(AC<0) , F <- 0"}else pdp8_obj.status.last_instr_exec="NOP"},exec_SZA=function(pdp8_obj){3===pdp8_obj.status.clock?(0===pdp8_obj.registers.AC&&pdp8_obj.registers.PC++,pdp8_obj.ctrlUnit.F=0,pdp8_obj.status.last_instr_exec="PC <- PC+1 if(AC==0) , F <- 0"):pdp8_obj.status.last_instr_exec="NOP"},exec_SZE=function(pdp8_obj){3===pdp8_obj.status.clock?(0===pdp8_obj.registers.E&&pdp8_obj.registers.PC++,pdp8_obj.ctrlUnit.F=0,pdp8_obj.status.last_instr_exec="PC <- PC+1 if(E==0) , F <- 0"):pdp8_obj.status.last_instr_exec="NOP"},exec_HLT=function(pdp8_obj){3===pdp8_obj.status.clock?(pdp8_obj.ctrlUnit.S=!1,pdp8_obj.status.last_instr_exec="S <- 0"):pdp8_obj.status.last_instr_exec="NOP"},exec_AND=function(pdp8_obj){0===pdp8_obj.status.clock?(pdp8_obj.registers.MAR=4095&pdp8_obj.registers.MBR,pdp8_obj.status.last_instr_exec="MAR <- MBR(AD)"):1===pdp8_obj.status.clock?(pdp8_obj.registers.MBR=pdp8_obj.ram.get(pdp8_obj.registers.MAR),pdp8_obj.status.last_instr_exec="MBR <- M"):2===pdp8_obj.status.clock?(pdp8_obj.registers.AC&=pdp8_obj.registers.MBR,pdp8_obj.status.last_instr_exec="AC <- AC AND MBR"):3===pdp8_obj.status.clock&&(pdp8_obj.ctrlUnit.F=0,pdp8_obj.status.last_instr_exec="F <- 0")},exec_ADD=function(pdp8_obj){if(0===pdp8_obj.status.clock)pdp8_obj.registers.MAR=4095&pdp8_obj.registers.MBR,pdp8_obj.status.last_instr_exec="MAR <- MBR(AD)";else if(1===pdp8_obj.status.clock)pdp8_obj.registers.MBR=pdp8_obj.ram.get(pdp8_obj.registers.MAR),pdp8_obj.status.last_instr_exec="MBR <- M";else if(2===pdp8_obj.status.clock){var tmp=pdp8_obj.registers.AC+pdp8_obj.registers.MBR&65535;32767<tmp&&(tmp-=Math.pow(2,16)),pdp8_obj.registers.E=0;((32768&pdp8_obj.registers.AC)>>15==1&&(32768&pdp8_obj.registers.MBR)>>15==1&&(32768&tmp)>>15==0||(32768&pdp8_obj.registers.AC)>>15==0&&(32768&pdp8_obj.registers.MBR)>>15==0&&(32768&tmp)>>15==1)&&(pdp8_obj.registers.E=1),pdp8_obj.registers.AC=tmp,pdp8_obj.status.last_instr_exec="E-AC <- AC + MBR"}else 3===pdp8_obj.status.clock&&(pdp8_obj.ctrlUnit.F=0,pdp8_obj.status.last_instr_exec="F <- 0")},exec_LDA=function(pdp8_obj){0===pdp8_obj.status.clock?(pdp8_obj.registers.MAR=4095&pdp8_obj.registers.MBR,pdp8_obj.status.last_instr_exec="MAR <- MBR(AD)"):1===pdp8_obj.status.clock?(pdp8_obj.registers.MBR=pdp8_obj.ram.get(pdp8_obj.registers.MAR),pdp8_obj.registers.AC=0,pdp8_obj.status.last_instr_exec="MBR <- M, AC <- 0"):2===pdp8_obj.status.clock?(pdp8_obj.registers.AC|=pdp8_obj.registers.MBR,pdp8_obj.status.last_instr_exec="AC <- AC + MBR"):3===pdp8_obj.status.clock&&(pdp8_obj.ctrlUnit.F=0,pdp8_obj.status.last_instr_exec="F <- 0")},exec_STA=function(pdp8_obj){0===pdp8_obj.status.clock?(pdp8_obj.registers.MAR=4095&pdp8_obj.registers.MBR,pdp8_obj.status.last_instr_exec="MAR <- MBR(AD)"):1===pdp8_obj.status.clock?(pdp8_obj.registers.MBR=pdp8_obj.registers.AC,pdp8_obj.status.last_instr_exec="MBR <- AC"):2===pdp8_obj.status.clock?(pdp8_obj.ram.set(pdp8_obj.registers.MAR,pdp8_obj.registers.MBR),pdp8_obj.status.last_instr_exec="M <- MBR"):3===pdp8_obj.status.clock&&(pdp8_obj.ctrlUnit.F=0,pdp8_obj.status.last_instr_exec="F <- 0")},exec_BUN=function(pdp8_obj){0===pdp8_obj.status.clock?(pdp8_obj.registers.PC=4095&pdp8_obj.registers.MBR,pdp8_obj.status.last_instr_exec="PC <- MBR(AD)"):3===pdp8_obj.status.clock?(pdp8_obj.ctrlUnit.F=0,pdp8_obj.status.last_instr_exec="F <- 0"):pdp8_obj.status.last_instr_exec="NOP"},exec_BSA=function(pdp8_obj){0===pdp8_obj.status.clock?(pdp8_obj.registers.MAR=4095&pdp8_obj.registers.MBR,pdp8_obj.registers.MBR&=0,pdp8_obj.registers.MBR|=pdp8_obj.registers.PC,pdp8_obj.status.last_instr_exec="MAR <- MBR(AD) , MBR <- 0, MBR(AD) <- PC"):1===pdp8_obj.status.clock?(pdp8_obj.ram.set(pdp8_obj.registers.MAR,pdp8_obj.registers.MBR),pdp8_obj.status.last_instr_exec="M <- MBR"):2===pdp8_obj.status.clock?(pdp8_obj.registers.PC=pdp8_obj.registers.MAR+1,pdp8_obj.status.last_instr_exec="PC <- MAR+1"):3===pdp8_obj.status.clock&&(pdp8_obj.ctrlUnit.F=0,pdp8_obj.status.last_instr_exec="F <- 0")},exec_ISZ=function(pdp8_obj){0===pdp8_obj.status.clock?(pdp8_obj.registers.MAR=4095&pdp8_obj.registers.MBR,pdp8_obj.status.last_instr_exec="MAR <- MBR(AD)"):1===pdp8_obj.status.clock?(pdp8_obj.registers.MBR=pdp8_obj.ram.get(pdp8_obj.registers.MAR),pdp8_obj.status.last_instr_exec="MBR <- M"):2===pdp8_obj.status.clock?(pdp8_obj.registers.MBR++,pdp8_obj.registers.MBR&=65535,pdp8_obj.status.last_instr_exec="MBR <- MBR + 1"):3===pdp8_obj.status.clock&&(pdp8_obj.ram.set(pdp8_obj.registers.MAR,pdp8_obj.registers.MBR),0===pdp8_obj.registers.MBR&&pdp8_obj.registers.PC++,pdp8_obj.ctrlUnit.F=0,pdp8_obj.status.last_instr_exec="M <- MBR , PC <- PC+1 if(MBR==0) , F <- 0")},exec_ION=function(pdp8_obj){3===pdp8_obj.status.clock?(pdp8_obj.ctrlUnit.INT=!0,pdp8_obj.ctrlUnit.F=0,pdp8_obj.ctrlUnit.R=0,pdp8_obj.status.last_instr_exec="INT <- true , F <- 0 , R <- 0"):pdp8_obj.status.last_instr_exec="NOP"},exec_IOF=function(pdp8_obj){3===pdp8_obj.status.clock?(pdp8_obj.ctrlUnit.INT=!1,pdp8_obj.ctrlUnit.F=0,pdp8_obj.ctrlUnit.R=0,pdp8_obj.status.last_instr_exec="INT <- true , F <- 0 , R <- 0"):pdp8_obj.status.last_instr_exec="NOP"},exec_INP=function(pdp8_obj){2===pdp8_obj.status.clock?pdp8_obj.ctrlUnit.INT&&(pdp8_obj.IO.wait=!0,pdp8_obj.status.last_instr_exec="wait for input..."):3===pdp8_obj.status.clock?(pdp8_obj.ctrlUnit.INT?-1!==pdp8_obj.IO.inp_buff&&(pdp8_obj.registers.AC=pdp8_obj.IO.inp_buff,pdp8_obj.ctrlUnit.F=0,pdp8_obj.ctrlUnit.R=0,pdp8_obj.IO.inp_buff=-1):(pdp8_obj.ctrlUnit.F=0,pdp8_obj.ctrlUnit.R=0),pdp8_obj.IO.wait=!1,pdp8_obj.status.last_instr_exec="AC <- input_buf , F <- 0 , R <- 0"):pdp8_obj.status.last_instr_exec="NOP"},exec_OUT=function(pdp8_obj){3===pdp8_obj.status.clock?(!0===pdp8_obj.ctrlUnit.INT&&(pdp8_obj.IO.screen+=String.fromCharCode(pdp8_obj.registers.AC)),pdp8_obj.ctrlUnit.F=0,pdp8_obj.ctrlUnit.R=0,pdp8_obj.status.last_instr_exec="screen <- AC , F <- 0 , R <- 0"):pdp8_obj.status.last_instr_exec="NOP"},PDP8=function(){function PDP8(){_classCallCheck(this,PDP8),this.text="",this.tokens=[],this.ram=new Map,this.status={start_add:0,clock:0,current_add_cmd:-1,cycle:"FETCH",last_instr_exec:"NOP"},this.IO={screen:"",inp_buff:-1,wait:!1},this.code_ref=new Map,this.registers={PC:0,MAR:0,MBR:0,OPR:0,I:0,E:0,AC:0},this.ctrlUnit={S:!1,F:0,R:0,INT:!0}}return _createClass(PDP8,[{key:"start",value:function(){return this.ctrlUnit.S=!0,this}},{key:"stop",value:function(){return this.ctrlUnit.S=!1,this}},{key:"step",value:function(){return this.ctrlUnit.S&&(0===this.ctrlUnit.F&&0===this.ctrlUnit.R?function(pdp8_obj){0===pdp8_obj.status.clock?(pdp8_obj.registers.MAR=pdp8_obj.registers.PC,pdp8_obj.status.current_add_cmd=pdp8_obj.registers.MAR,pdp8_obj.status.last_instr_exec="MAR <- PC"):1===pdp8_obj.status.clock?(pdp8_obj.registers.MBR=pdp8_obj.ram.get(pdp8_obj.registers.MAR),pdp8_obj.registers.PC++,pdp8_obj.status.last_instr_exec="MBR <- M , PC <- PC+1"):2===pdp8_obj.status.clock?(pdp8_obj.registers.OPR=(28672&pdp8_obj.registers.MBR)>>12,pdp8_obj.registers.I=(32768&pdp8_obj.registers.MBR)>>15,pdp8_obj.status.last_instr_exec="OPR <- MBR(OP) , I <- MBR(I)"):3===pdp8_obj.status.clock&&(1===pdp8_obj.registers.I&&7!==pdp8_obj.registers.OPR?pdp8_obj.ctrlUnit.R=1:pdp8_obj.ctrlUnit.F=1,pdp8_obj.status.last_instr_exec="if I == 1 && OPR != 111 => R <- 1 else F <- 1")}(this):0===this.ctrlUnit.F&&1===this.ctrlUnit.R?function(pdp8_obj){0===pdp8_obj.status.clock?pdp8_obj.registers.MAR=4095&pdp8_obj.registers.MBR:1===pdp8_obj.status.clock?pdp8_obj.registers.MBR=pdp8_obj.ram.get(pdp8_obj.registers.MAR):2===pdp8_obj.status.clock||3===pdp8_obj.status.clock&&(pdp8_obj.ctrlUnit.R=0,pdp8_obj.ctrlUnit.F=1)}(this):1===this.ctrlUnit.F&&0===this.ctrlUnit.R?function(pdp8_obj){1===pdp8_obj.registers.I&&7===pdp8_obj.registers.OPR?pdp8_obj.ctrlUnit.R=1:0===pdp8_obj.registers.I&&7===pdp8_obj.registers.OPR?pdp8_obj.registers.MBR===binOpt.CLA?exec_CLA(pdp8_obj):pdp8_obj.registers.MBR===binOpt.CLE?exec_CLE(pdp8_obj):pdp8_obj.registers.MBR===binOpt.CMA?exec_CMA(pdp8_obj):pdp8_obj.registers.MBR===binOpt.CME?exec_CME(pdp8_obj):pdp8_obj.registers.MBR===binOpt.CIR?exec_CIR(pdp8_obj):pdp8_obj.registers.MBR===binOpt.CIL?exec_CIL(pdp8_obj):pdp8_obj.registers.MBR===binOpt.INC?exec_INC(pdp8_obj):pdp8_obj.registers.MBR===binOpt.SPA?exec_SPA(pdp8_obj):pdp8_obj.registers.MBR===binOpt.SNA?exec_SNA(pdp8_obj):pdp8_obj.registers.MBR===binOpt.SZA?exec_SZA(pdp8_obj):pdp8_obj.registers.MBR===binOpt.SZE?exec_SZE(pdp8_obj):pdp8_obj.registers.MBR===binOpt.HLT&&exec_HLT(pdp8_obj):pdp8_obj.registers.OPR===(28672&binOpt.AND)>>12?exec_AND(pdp8_obj):pdp8_obj.registers.OPR===(28672&binOpt.ADD)>>12?exec_ADD(pdp8_obj):pdp8_obj.registers.OPR===(28672&binOpt.LDA)>>12?exec_LDA(pdp8_obj):pdp8_obj.registers.OPR===(28672&binOpt.STA)>>12?exec_STA(pdp8_obj):pdp8_obj.registers.OPR===(28672&binOpt.BUN)>>12?exec_BUN(pdp8_obj):pdp8_obj.registers.OPR===(28672&binOpt.BSA)>>12?exec_BSA(pdp8_obj):pdp8_obj.registers.OPR===(28672&binOpt.ISZ)>>12&&exec_ISZ(pdp8_obj)}(this):1===this.ctrlUnit.F&&1===this.ctrlUnit.R&&function(pdp8_obj){pdp8_obj.registers.MBR===binOpt.INP&&exec_INP(pdp8_obj),pdp8_obj.registers.MBR===binOpt.OUT&&exec_OUT(pdp8_obj),pdp8_obj.registers.MBR===binOpt.ION&&exec_ION(pdp8_obj),pdp8_obj.registers.MBR===binOpt.IOF&&exec_IOF(pdp8_obj)}(this),0===this.ctrlUnit.F&&0===this.ctrlUnit.R?this.status.cycle="FETCH":0===this.ctrlUnit.F&&1===this.ctrlUnit.R?this.status.cycle="INDIRECT":1===this.ctrlUnit.F&&0===this.ctrlUnit.R?this.status.cycle="EXECUTE":1===this.ctrlUnit.F&&1===this.ctrlUnit.R&&(this.status.cycle="INTERRUPT"),this.status.clock=(this.status.clock+1)%4),this}},{key:"next",value:function(){if(this.ctrlUnit.S){var cur_add=this.status.current_add_cmd;for(-1===cur_add&&(this.step(),cur_add=this.status.current_add_cmd);this.status.current_add_cmd===cur_add&&this.ctrlUnit.S&&(this.step(),!this.IO.wait););}return this}},{key:"reset",value:function(){return this.registers={PC:this.status.start_add,MAR:0,MBR:0,OPR:0,I:0,E:0,AC:0},this.ctrlUnit={S:!1,F:0,R:0,INT:!0},this.IO={screen:"",inp_buff:-1,wait:!1},this.status.clock=0,this.status.current_add_cmd=this.status.start_add,this.status.cycle="FETCH",this.status.last_instr_exec="NOP",this}},{key:"explain",value:function(binCode){var res={};res.title=binCode[0]+" | ",res.title+=binCode.slice(1,4)+" | ",res.title+=binCode.slice(4);var tmp=res.content="",dec_val=parseInt(binCode,2);for(var key in binOpt){if(dec_val===binOpt[key]){tmp=key;break}if((28672&dec_val)===binOpt[key]){tmp=key;break}}return res.content+="Opcode: "+tmp+"\n",res.content+="Addr(Hex): 0x"+(4095&dec_val).toString(16)+"\n","0"!==binCode[0]&&(dec_val=parseInt(binCode,2)-Math.pow(2,16)),res.content+="Dec Val(compl 2): "+dec_val.toString()+"\n",res.content+="Hex Val: "+parseInt(binCode,2).toString(16)+"\n",res}},{key:"getTokens",value:function(){var tmp="",cur_type=null,_iteratorNormalCompletion6=!0,_didIteratorError6=!(this.tokens=[]),_iteratorError6=void 0;try{for(var _step6,_iterator6=this.text[Symbol.iterator]();!(_iteratorNormalCompletion6=(_step6=_iterator6.next()).done);_iteratorNormalCompletion6=!0){var char=_step6.value;checkType(char)===types.BLANK?(0!==tmp.length&&this.tokens.push(new Token(cur_type,tmp)),tmp="",cur_type=null):checkType(char)===types.NEWLINE?(0!==tmp.length&&this.tokens.push(new Token(cur_type,tmp)),this.tokens.push(new Token(checkType(char),char)),tmp="",cur_type=null):checkType(char)===types.PUNCT&&cur_type!==types.PUNCT?(0!==tmp.length&&this.tokens.push(new Token(cur_type,tmp)),cur_type=checkType(tmp=char)):checkType(char)!==types.BLANK&&(cur_type=cur_type===types.PUNCT&&checkType(char)!==types.PUNCT?(this.tokens.push(new Token(cur_type,tmp)),checkType(tmp=char)):checkType(tmp+=char))}}catch(err){_didIteratorError6=!0,_iteratorError6=err}finally{try{!_iteratorNormalCompletion6&&_iterator6.return&&_iterator6.return()}finally{if(_didIteratorError6)throw _iteratorError6}}return null!==cur_type&&this.tokens.push(new Token(cur_type,tmp)),this}},{key:"setText",value:function(text){return"string"==typeof text?(this.text=text.replace(/(\r\n|\r)/g,"\n"),"\n"!==this.text.charAt(this.text.length-1)&&(this.text+="\n")):this.text="",this}},{key:"getRam",value:function(){var tmp="",counter=0,_iteratorNormalCompletion7=!0,_didIteratorError7=!1,_iteratorError7=void 0;try{for(var _step7,_iterator7=this.ram.values()[Symbol.iterator]();!(_iteratorNormalCompletion7=(_step7=_iterator7.next()).done);_iteratorNormalCompletion7=!0){var value=_step7.value;tmp+=to_base_2(value,16)+(counter<this.ram.size-1?"\n":""),counter++}}catch(err){_didIteratorError7=!0,_iteratorError7=err}finally{try{!_iteratorNormalCompletion7&&_iterator7.return&&_iterator7.return()}finally{if(_didIteratorError7)throw _iteratorError7}}return tmp}},{key:"getRegisters",value:function(){var regs={};return regs.PC=to_base_2(this.registers.PC,12),regs.MBR=to_base_2(this.registers.MBR,16),regs.AC=to_base_2(this.registers.AC,16),32767<this.registers.AC?regs.AC_INT=this.registers.AC-Math.pow(2,16):regs.AC_INT=this.registers.AC,regs.AC_HEX=parseInt(regs.AC,2).toString(16).toUpperCase(),regs.MAR=to_base_2(this.registers.MAR,12),regs.OPR=to_base_2(this.registers.OPR,3),regs.I=to_base_2(this.registers.I,1),regs.E=to_base_2(this.registers.E,1),regs}},{key:"getSourceLine",value:function(ramPos){var real_addr=ramPos+this.status.start_add,_iteratorNormalCompletion8=!0,_didIteratorError8=!1,_iteratorError8=void 0;try{for(var _step8,_iterator8=this.code_ref.keys()[Symbol.iterator]();!(_iteratorNormalCompletion8=(_step8=_iterator8.next()).done);_iteratorNormalCompletion8=!0){var key=_step8.value;if(this.code_ref.get(key)===real_addr)return key}}catch(err){_didIteratorError8=!0,_iteratorError8=err}finally{try{!_iteratorNormalCompletion8&&_iterator8.return&&_iterator8.return()}finally{if(_didIteratorError8)throw _iteratorError8}}}},{key:"getCodeRef",value:function(){var references={PC:{ram:-1,source:-1},MAR:{ram:-1,source:-1},CUR_CMD:{ram:-1,source:-1}},_iteratorNormalCompletion9=!0,_didIteratorError9=!1,_iteratorError9=void 0;try{for(var _step9,_iterator9=this.code_ref.keys()[Symbol.iterator]();!(_iteratorNormalCompletion9=(_step9=_iterator9.next()).done);_iteratorNormalCompletion9=!0){var key=_step9.value;this.code_ref.get(key)===this.registers.PC&&(references.PC.source=key,references.PC.ram=this.code_ref.get(key)-this.status.start_add+1),this.code_ref.get(key)===this.registers.MAR&&(references.MAR.source=key,references.MAR.ram=this.code_ref.get(key)-this.status.start_add+1),this.code_ref.get(key)===this.status.current_add_cmd&&(references.CUR_CMD.source=key,references.CUR_CMD.ram=this.code_ref.get(key)-this.status.start_add+1)}}catch(err){_didIteratorError9=!0,_iteratorError9=err}finally{try{!_iteratorNormalCompletion9&&_iterator9.return&&_iterator9.return()}finally{if(_didIteratorError9)throw _iteratorError9}}return references}},{key:"compile",value:function(text){this.setText(text).getTokens(),this.ram.clear(),this.code_ref.clear(),this.status.start_add=0,this.status.current_add_cmd=-1;for(var cur_add=this.status.start_add,cur_state=states.NONE,tmp_bin=0,lineNum=1,index=-1,flags={ORG:!1,END:!1,HLT:!1},errors={},labels={},to_resolve={},addInMem=function(pdp8_obj,binary){pdp8_obj.ram.set(cur_add,binary),pdp8_obj.code_ref.set(lineNum,cur_add),cur_add++};index<this.tokens.length-1;){index++;var cur_tok=this.tokens[index];if(cur_state===states.NONE)if(cur_tok.type===types.NEWLINE)cur_state=states.NONE,lineNum++;else if(cur_tok.type===types.PUNCT)cur_state="/*"===cur_tok.val?states.COMMENT_MULTILNE:"//"===cur_tok.val?states.COMMENT_INLINE:(errors["Error ("+lineNum+")"]="Wrong command!",states.ERROR);else if(cur_tok.type!==types.HEX_NUM&&cur_tok.type!==types.NUMBER||4!==cur_tok.val.length)cur_state=cur_tok.type===types.WORD?void 0!==this.tokens[index+1]&&this.tokens[index+1].type===types.PUNCT&&","===this.tokens[index+1].val?(labels[cur_tok.val]=cur_add,states.LABEL):"org"===cur_tok.val.toLowerCase()?(flags.ORG=!0,states.ORG):"end"===cur_tok.val.toLowerCase()?(flags.END=!0,states.END_CMD):"hlt"===cur_tok.val.toLowerCase()?(addInMem(this,binOpt[cur_tok.val.toUpperCase()]),flags.HLT=!0,states.END_CMD):"cla"===cur_tok.val.toLowerCase()||"cle"===cur_tok.val.toLowerCase()||"cma"===cur_tok.val.toLowerCase()||"cme"===cur_tok.val.toLowerCase()||"cir"===cur_tok.val.toLowerCase()||"cil"===cur_tok.val.toLowerCase()||"inc"===cur_tok.val.toLowerCase()||"spa"===cur_tok.val.toLowerCase()||"sza"===cur_tok.val.toLowerCase()||"sna"===cur_tok.val.toLowerCase()||"sze"===cur_tok.val.toLowerCase()?(addInMem(this,binOpt[cur_tok.val.toUpperCase()]),states.END_CMD):"inp"===cur_tok.val.toLowerCase()||"out"===cur_tok.val.toLowerCase()||"ion"===cur_tok.val.toLowerCase()||"iof"===cur_tok.val.toLowerCase()?(addInMem(this,binOpt[cur_tok.val.toUpperCase()]),states.END_CMD):"lda"===cur_tok.val.toLowerCase()||"sta"===cur_tok.val.toLowerCase()||"and"===cur_tok.val.toLowerCase()||"bun"===cur_tok.val.toLowerCase()||"bsa"===cur_tok.val.toLowerCase()||"isz"===cur_tok.val.toLowerCase()?(tmp_bin=binOpt[cur_tok.val.toUpperCase()],states.ADDRESS):"hex"===cur_tok.val.toLowerCase()?states.HEX_VAL:(to_resolve[cur_add]=cur_tok.val,addInMem(this,0),states.END_CMD):cur_tok.type===types.HEX_NUM?"dec"===cur_tok.val.toLowerCase()?states.DEC_VAL:"add"===cur_tok.val.toLowerCase()?(tmp_bin=binOpt[cur_tok.val.toUpperCase()],states.ADDRESS):void 0!==this.tokens[index+1]&&this.tokens[index+1].type===types.PUNCT&&","===this.tokens[index+1].val?(labels[cur_tok.val]=cur_add,states.LABEL):(errors["Error ("+lineNum+")"]="Bad command or label!",states.ERROR):(errors["Error ("+lineNum+")"]="Bad command!",states.ERROR);else{var tmp=parseInt(cur_tok.val,16);cur_state=0<=tmp?(addInMem(this,tmp),states.HEX_NUM):(errors["Error ("+lineNum+")"]="Hex value can't be negative!",states.ERROR)}else if(cur_state===states.COMMENT_MULTILNE)cur_tok.type===types.PUNCT&&"*/"===cur_tok.val?cur_state=states.NONE:cur_tok.type===types.NEWLINE&&lineNum++;else if(cur_state===states.COMMENT_INLINE)cur_tok.type===types.NEWLINE&&(lineNum++,cur_state=states.NONE);else if(cur_state===states.ADDRESS)if(cur_tok.type===types.HEX_NUM||cur_tok.type===types.NUMBER)if("dec"===cur_tok.val.toLowerCase()&&this.tokens[index+1].type===types.NUMBER)cur_state=states.ADDR_DEC_VAL;else if(3===cur_tok.val.length){tmp_bin|=parseInt(cur_tok.val,16),cur_state=states.INDIRECT}else cur_state=(labels.hasOwnProperty(cur_tok.val)?tmp_bin|=labels[cur_tok.val]:to_resolve[cur_add]=cur_tok.val,states.INDIRECT);else cur_state=cur_tok.type===types.WORD?"hex"===cur_tok.val.toLowerCase()?states.ADDR_HEX_VAL:(labels.hasOwnProperty(cur_tok.val)?tmp_bin|=labels[cur_tok.val]:to_resolve[cur_add]=cur_tok.val,states.INDIRECT):(errors["Error ("+lineNum+")"]="Wrong address!",states.ERROR);else if(cur_state===states.HEX_NUM)cur_state=cur_tok.type===types.NEWLINE?(lineNum++,states.NONE):(errors["Error ("+lineNum+")"]="Wrong HEX command!",states.ERROR);else if(cur_state===states.HEX_VAL)if(cur_tok.type===types.HEX_NUM||cur_tok.type===types.NUMBER){var _tmp2=parseInt(cur_tok.val,16);cur_state=0<=_tmp2?(addInMem(this,_tmp2),states.END_CMD):(errors["Error ("+lineNum+")"]="Hex value can't be negative!",states.ERROR)}else errors["Error ("+lineNum+")"]="Wrong HEX value!",cur_state=states.ERROR;else if(cur_state===states.DEC_VAL)cur_state=cur_tok.type===types.NUMBER?(addInMem(this,parseInt(cur_tok.val)),states.END_CMD):(errors["Error ("+lineNum+")"]="Wrong DEC value!",states.ERROR);else if(cur_state===states.ADDR_HEX_VAL)if(cur_tok.type===types.HEX_NUM||cur_tok.type===types.NUMBER){var _tmp3=parseInt(cur_tok.val,16);cur_state=0<=_tmp3?(addInMem(this,tmp_bin|_tmp3),states.END_CMD):(errors["Error ("+lineNum+")"]="Hex address can't be negative!",states.ERROR)}else errors["Error ("+lineNum+")"]="Wrong HEX value address!",cur_state=states.ERROR;else cur_state===states.ADDR_DEC_VAL?cur_state=cur_tok.type===types.NUMBER?(addInMem(this,parseInt(cur_tok.val)),states.INDIRECT):(errors["Error ("+lineNum+")"]="Wrong DEC value address!",states.ERROR):cur_state===states.LABEL?cur_state=cur_tok.type===types.PUNCT&&","===cur_tok.val?states.NONE:(errors["Error ("+lineNum+")"]="Wrong label declaration!",states.ERROR):cur_state===states.ORG?cur_state=(cur_tok.type===types.HEX_NUM||cur_tok.type===types.NUMBER)&&0<=parseInt(cur_tok.val,16)?(this.status.start_add=parseInt(cur_tok.val,16),cur_add=parseInt(cur_tok.val,16),states.END_CMD):(errors["Error ("+lineNum+")"]="Wrong ORG address!",states.ERROR):cur_state===states.INDIRECT?cur_state=cur_tok.type===types.NEWLINE?(addInMem(this,tmp_bin),lineNum++,states.NONE):cur_tok.type===types.WORD&&"i"===cur_tok.val.toLowerCase()?(addInMem(this,tmp_bin|=32768),states.END_CMD):cur_tok.type===types.PUNCT?"/*"===cur_tok.val?(addInMem(this,tmp_bin),states.COMMENT_MULTILNE):"//"===cur_tok.val?(addInMem(this,tmp_bin),states.COMMENT_INLINE):(errors["Error ("+lineNum+")"]="Wrong command!",states.ERROR):(errors["Error ("+lineNum+")"]="Wrong indirect address!",states.ERROR):cur_state===states.END_CMD?cur_state=cur_tok.type===types.NEWLINE?(lineNum++,states.NONE):cur_tok.type===types.PUNCT?"/*"===cur_tok.val?states.COMMENT_MULTILNE:"//"===cur_tok.val?states.COMMENT_INLINE:(errors["Error ("+lineNum+")"]="Wrong command!",states.ERROR):(errors["Error ("+lineNum+")"]="Wrong command!",states.ERROR):cur_state===states.ERROR&&cur_tok.type===types.NEWLINE&&(lineNum++,cur_state=states.NONE)}for(var mem_add in to_resolve)this.ram.set(+mem_add,this.ram.get(+mem_add)|labels[to_resolve[mem_add]]),labels.hasOwnProperty(to_resolve[mem_add])&&delete to_resolve[mem_add];if(0!==Object.keys(to_resolve).length)for(var _mem_add in to_resolve)errors["Error (LABEL["+to_resolve[_mem_add]+"])"]="Missing LABEL reference!";for(var label in flags.ORG&&!flags.END&&(errors["Error (ORG)"]="Missing END command!"),!flags.ORG&&flags.END&&(errors["Error (END)"]="Missing ORG command!"),flags.ORG||flags.END||(errors["Warning (ORG)"]="ORG and END commands not found!"),flags.HLT||(errors["Warning (HLT)"]="HTL command not found!"),this.reset(),errors)if(-1!==label.indexOf("Error")){this.ram.clear(),this.code_ref.clear(),this.status.start_add=0,this.status.current_add_cmd=-1,this.reset();break}return errors}}]),PDP8}(),root="object"==("undefined"==typeof self?"undefined":_typeof(self))&&self.self===self&&self||"object"==("undefined"==typeof global?"undefined":_typeof(global))&&global.global===global&&global||this;"undefined"==typeof exports||exports.nodeType?root.PDP8=PDP8:("undefined"!=typeof module&&!module.nodeType&&module.exports&&(exports=module.exports=PDP8),exports.PDP8=PDP8)}();